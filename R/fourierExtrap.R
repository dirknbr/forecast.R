

# translation of https://gist.github.com/tartakynov/83f3cd8f44208a1856ce into R

fftfreq <- function(n, d = 1.0) {
  # fft frequencies, same as in numpy
  stopifnot(n %% 1 == 0) # is int
  if (n %% 2 == 0) {
    f <- c(0:(n / 2 - 1), - (n / 2):(- 1)) / (d * n)
  } else {
    f <- c(0:((n - 1) / 2), - ((n - 1)/ 2):(- 1)) / (d * n)
  }
  return(f)
}

fourierExtrap <- function(x, n_predict, n_harm = 8) {
  # Args:
  #  x: vector
  #  n_predict: forecast horizon

  n <- length(x)
  t <- 0:(n - 1)
  p <- lm(x ~ t)
  x_notrend <- x - coef(p)[2] * t
  x_freqdom <- fft(x_notrend)
  f <- fftfreq(n)
  indexes <- 1:n
  # sort indices by order of abs f
  indexes <- indexes[order(abs(f))]
  
  t <- 0:(n - 1 + n_predict)
  restored_sig <- rep(0, length(t))
  for (i in indexes[1:(n_harm * 2)]) {
    ampli <- abs(x_freqdom[i]) / n
    phase <- Arg(x_freqdom[i]) # angle of complex
    restored_sig <- restored_sig + ampli * cos(2 * pi * f[i] * t + phase)
  }
  return(restored_sig + coef(p)[2]  * t)  
}

# x <- c(669, 592, 664, 1005, 699, 401, 646, 472, 598, 681, 1126, 1260, 562, 491, 714, 530, 521, 687, 776, 802, 499, 536, 871, 801, 965, 768, 381, 497, 458, 699, 549, 427, 358, 219, 635, 756, 775, 969, 598, 630, 649, 722, 835, 812, 724, 966, 778, 584, 697, 737, 777, 1059, 1218, 848, 713, 884, 879, 1056, 1273, 1848, 780, 1206, 1404, 1444, 1412, 1493, 1576, 1178, 836, 1087, 1101, 1082, 775, 698, 620, 651, 731, 906, 958, 1039, 1105, 620, 576, 707, 888, 1052, 1072, 1357, 768, 986, 816, 889, 973, 983, 1351, 1266, 1053, 1879, 2085, 2419, 1880, 2045, 2212, 1491, 1378, 1524, 1231, 1577, 2459, 1848, 1506, 1589, 1386, 1111, 1180, 1075, 1595, 1309, 2092, 1846, 2321, 2036, 3587, 1637, 1416, 1432, 1110, 1135, 1233, 1439, 894, 628, 967, 1176, 1069, 1193, 1771, 1199, 888, 1155, 1254, 1403, 1502, 1692, 1187, 1110, 1382, 1808, 2039, 1810, 1819, 1408, 803, 1568, 1227, 1270, 1268, 1535, 873, 1006, 1328, 1733, 1352, 1906, 2029, 1734, 1314, 1810, 1540, 1958, 1420, 1530, 1126, 721, 771, 874, 997, 1186, 1415, 973, 1146, 1147, 1079, 3854, 3407, 2257, 1200, 734, 1051, 1030, 1370, 2422, 1531, 1062, 530, 1030, 1061, 1249, 2080, 2251, 1190, 756, 1161, 1053, 1063, 932, 1604, 1130, 744, 930, 948, 1107, 1161, 1194, 1366, 1155, 785, 602, 903, 1142, 1410, 1256, 742, 985, 1037, 1067, 1196, 1412, 1127, 779, 911, 989, 946, 888, 1349, 1124, 761, 994, 1068, 971, 1157, 1558, 1223, 782, 2790, 1835, 1444, 1098, 1399, 1255, 950, 1110, 1345, 1224, 1092, 1446, 1210, 1122, 1259, 1181, 1035, 1325, 1481, 1278, 769, 911, 876, 877, 950, 1383, 980, 705, 888, 877, 638, 1065, 1142, 1090, 1316, 1270, 1048, 1256, 1009, 1175, 1176, 870, 856, 860)
# 
# n_predict <- 100
# extrap <- fourierExtrap(x, n_predict)
# matplot(cbind(c(x, rep(NA, n_predict)), extrap), type = 'l')
# 
# # sensitivity to n_harm
# train <- 1:270
# n_predict <- 18
# for (nh in 2:20) {
#   p <- fourierExtrap(x[train], n_predict, nh)
#   cat(nh, mape(x[-train], tail(p, n_predict)), '\n')
# }
# 
# # 1, 5, 8, 17 are local minima
# 
